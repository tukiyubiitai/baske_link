import 'package:basketball_app/utils/error_handler.dart';import 'package:firebase_auth/firebase_auth.dart';import 'package:flutter/material.dart';import 'package:flutter_riverpod/flutter_riverpod.dart';import '../../infrastructure/firebase/account_firebase.dart';import '../../infrastructure/service/firebase_account_service.dart';import '../../models/account/account.dart';import '../../utils/loading_manager.dart';import '../dialogs/snackbar_utils.dart';import '../state/providers/account/account_notifier.dart';import '../state/providers/account/account_state_notifier.dart';import '../state/providers/providers.dart';///ユーザーアカウントの登録と更新と削除するclass AccountViewModel extends ChangeNotifier {  final FirebaseAccountService _firebaseService = FirebaseAccountService();  final loadingManager = LoadingManager();  final errorHandler = ErrorHandler();  /// アカウント登録処理  /// authのユーザーを取得し、新しいアカウントデータをFirebaseに保存します。  Future<void> createUserAccount(WidgetRef ref) async {    try {      // 現在のユーザーを取得      final User? user = await _firebaseService.getCurrentUser();      if (user == null) {        ref.read(errorMessageProvider.notifier).state = "ユーザーが見つかりません";        return;      }      // 以下、アカウント保存処理      var accountState = ref.read(accountStateNotifierProvider);      //入力検証のロジック      if (!_validateName(accountState.name, ref)) {        return;      }      // ロード開始      loadingManager.startLoading(ref);      // アカウントオブジェクトを取得      final Account newAccount = await prepareNewUserAccountData(          user.uid, accountState.name, accountState.imagePath);      // firestore　保存処理      var result = await AccountFirestore().saveNewUserToFirestore(newAccount);      if (result) {        //riverpodにAccountの状態を保存        ref.read(accountNotifierProvider.notifier).updateAccount(newAccount);        //完了を通知        ref            .read(accountStateNotifierProvider.notifier)            .onUserIsAccountCreatedSuccessfully(true);        return;      }    } catch (e) {      // エラーステートを設定する      errorHandler.setErrorState(ref, getErrorMessage(e));    } finally {      // ロード終了      loadingManager.stopLoading(ref);    }  }  /// アカウント更新処理  /// 変更されたユーザー情報をFirebaseに保存します。  Future<void> updateUserAccount(bool isImageDeleted, WidgetRef ref) async {    try {      final Account myAccount = ref.read(accountNotifierProvider);      ;      // ユーザーの名前や画像が変更されている場合にFirebaseに情報を更新      var accountState = ref.read(accountStateNotifierProvider);      String name = accountState.name;      String oldName = myAccount.name;      String? imagePath = accountState.imagePath;      String oldImagePath = myAccount.imagePath ?? '';      //入力検証のロジック      if (!_validateName(accountState.name, ref)) {        return;      }      // 名前と画像に変更がない場合、早期に関数を終了      if (name == oldName && !isImageDeleted && imagePath == oldImagePath) {        showErrorSnackBar(context: ref.context, text: "変更がありません");        return;      }      // ロード開始      loadingManager.startLoading(ref);      // アカウントオブジェクトを取得      final Account updateAccount =          await AccountFirestore.prepareUpdatedUserAccountData(              myAccount.id,              accountState.name,              accountState.imagePath,              isImageDeleted,              myAccount.imagePath ?? '');      // firestore 更新処理      var result =          await AccountFirestore().saveUpdatedUserToFirestore(updateAccount);      if (result) {        //riverpodにAccountの状態を保存        ref.read(accountNotifierProvider.notifier).updateAccount(updateAccount);        //完了を通知        ref.read(accountStateNotifierProvider.notifier).onUserIsEditing(true);        return;      }    } catch (e) {      // エラーステートを設定する      errorHandler.setErrorState(ref, getErrorMessage(e));    } finally {      // ロード終了      loadingManager.stopLoading(ref);    }  }  /// アカウント削除処理  /// ユーザーのアカウントをFirebaseから削除します。  Future<bool> deleteUserAccount(WidgetRef ref) async {    try {      final Account myAccount = ref.read(accountNotifierProvider);      ;      // ロード開始      loadingManager.startLoading(ref);      //削除処理      var result = await AccountFirestore().deleteCurrentUser(myAccount);      return result;    } catch (e) {      // エラーステートを設定する      errorHandler.setErrorState(ref, getErrorMessage(e));      return false;    } finally {      // ロード終了      loadingManager.stopLoading(ref);    }  }  /// 新しいユーザーアカウントデータの準備  /// Firebaseに保存するための新しいアカウントオブジェクトを作成します。  Future<Account> prepareNewUserAccountData(      String uid, String name, String? imagePath) async {    // トークン取得    final registrationToken = await _firebaseService.getToken();    // 画像アップロード    String? image = await _firebaseService.uploadUserImage(imagePath ?? "");    // アカウントオブジェクト作成    final Account newAccount = Account(        id: uid,        name: name,        myToken: registrationToken.toString(),        imagePath: image ?? "");    return newAccount;  }  /// 名前の検証メソッド  /// 入力された名前が適切かどうかを検証します。  bool _validateName(String name, WidgetRef ref) {    if (name.isEmpty) {      errorHandler.setErrorState(ref, "名前が入力されていません");      return false;    }    if (name.length < 1) {      errorHandler.setErrorState(ref, "名前が短いです");      return false;    }    return true;  }}